{"version":3,"file":"challenges-BsLvdXcT.js","sources":["../../assets/js/challenges.js"],"sourcesContent":["import Alpine from \"alpinejs\";\nimport dayjs from \"dayjs\";\n\nimport CTFd from \"./index\";\n\nimport { Modal, Tab, Tooltip } from \"bootstrap\";\nimport highlight from \"./theme/highlight\";\n\nfunction addTargetBlank(html) {\n  let dom = new DOMParser();\n  let view = dom.parseFromString(html, \"text/html\");\n  let links = view.querySelectorAll('a[href*=\"://\"]');\n  links.forEach(link => {\n    link.setAttribute(\"target\", \"_blank\");\n  });\n  return view.documentElement.outerHTML;\n}\n\nwindow.Alpine = Alpine;\n\nAlpine.store(\"challenge\", {\n  data: {\n    view: \"\",\n  },\n});\n\nAlpine.data(\"Hint\", () => ({\n  id: null,\n  html: null,\n\n  async showHint(event) {\n    if (event.target.open) {\n      let response = await CTFd.pages.challenge.loadHint(this.id);\n      let hint = response.data;\n      if (hint.content) {\n        this.html = addTargetBlank(hint.html);\n      } else {\n        let answer = await CTFd.pages.challenge.displayUnlock(this.id);\n        if (answer) {\n          let unlock = await CTFd.pages.challenge.loadUnlock(this.id);\n\n          if (unlock.success) {\n            let response = await CTFd.pages.challenge.loadHint(this.id);\n            let hint = response.data;\n            this.html = addTargetBlank(hint.html);\n          } else {\n            event.target.open = false;\n            CTFd._functions.challenge.displayUnlockError(unlock);\n          }\n        } else {\n          event.target.open = false;\n        }\n      }\n    }\n  },\n}));\n\nAlpine.data(\"Challenge\", () => ({\n  id: null,\n  next_id: null,\n  submission: \"\",\n  tab: null,\n  solves: [],\n  response: null,\n  share_url: null,\n  max_attempts: 0,\n  attempts: 0,\n\n  async init() {\n    highlight();\n  },\n\n  getStyles() {\n    let styles = {\n      \"modal-dialog\": true,\n    };\n    try {\n      let size = CTFd.config.themeSettings.challenge_window_size;\n      switch (size) {\n        case \"sm\":\n          styles[\"modal-sm\"] = true;\n          break;\n        case \"lg\":\n          styles[\"modal-lg\"] = true;\n          break;\n        case \"xl\":\n          styles[\"modal-xl\"] = true;\n          break;\n        default:\n          break;\n      }\n    } catch (error) {\n      // Ignore errors with challenge window size\n      console.log(\"Error processing challenge_window_size\");\n      console.log(error);\n    }\n    return styles;\n  },\n\n  async init() {\n    highlight();\n  },\n\n  async showChallenge() {\n    new Tab(this.$el).show();\n  },\n\n  async showSolves() {\n    this.solves = await CTFd.pages.challenge.loadSolves(this.id);\n    this.solves.forEach(solve => {\n      solve.date = dayjs(solve.date).format(\"MMMM Do, h:mm:ss A\");\n      return solve;\n    });\n    new Tab(this.$el).show();\n  },\n\n  getNextId() {\n    let data = Alpine.store(\"challenge\").data;\n    return data.next_id;\n  },\n\n  async nextChallenge() {\n    let modal = Modal.getOrCreateInstance(\"[x-ref='challengeWindow']\");\n\n    // TODO: Get rid of this private attribute access\n    // See https://github.com/twbs/bootstrap/issues/31266\n    modal._element.addEventListener(\n      \"hidden.bs.modal\",\n      event => {\n        // Dispatch load-challenge event to call loadChallenge in the ChallengeBoard\n        Alpine.nextTick(() => {\n          this.$dispatch(\"load-challenge\", this.getNextId());\n        });\n      },\n      { once: true },\n    );\n    modal.hide();\n  },\n\n  async getShareUrl() {\n    let body = {\n      type: \"solve\",\n      challenge_id: this.id,\n    };\n    const response = await CTFd.fetch(\"/api/v1/shares\", {\n      method: \"POST\",\n      body: JSON.stringify(body),\n    });\n    const data = await response.json();\n    const url = data[\"data\"][\"url\"];\n    this.share_url = url;\n  },\n\n  copyShareUrl() {\n    navigator.clipboard.writeText(this.share_url);\n    let t = Tooltip.getOrCreateInstance(this.$el);\n    t.enable();\n    t.show();\n    setTimeout(() => {\n      t.hide();\n      t.disable();\n    }, 2000);\n  },\n\n  async submitChallenge() {\n    this.response = await CTFd.pages.challenge.submitChallenge(\n      this.id,\n      this.submission,\n    );\n\n    await this.renderSubmissionResponse();\n  },\n\n  async renderSubmissionResponse() {\n    if (this.response.data.status === \"correct\") {\n      this.submission = \"\";\n    }\n\n    // Increment attempts counter\n    if (this.max_attempts > 0 && this.response.data.status != \"already_solved\") {\n      this.attempts += 1;\n    }\n\n    // Dispatch load-challenges event to call loadChallenges in the ChallengeBoard\n    this.$dispatch(\"load-challenges\");\n  },\n}));\n\nAlpine.data(\"ChallengeBoard\", () => ({\n  loaded: false,\n  challenges: [],\n  challenge: null,\n\n  async init() {\n    this.challenges = await CTFd.pages.challenges.getChallenges();\n    this.loaded = true;\n\n    if (window.location.hash) {\n      let chalHash = decodeURIComponent(window.location.hash.substring(1));\n      let idx = chalHash.lastIndexOf(\"-\");\n      if (idx >= 0) {\n        let pieces = [chalHash.slice(0, idx), chalHash.slice(idx + 1)];\n        let id = pieces[1];\n        await this.loadChallenge(id);\n      }\n    }\n  },\n\n  getCategories() {\n    const categories = [];\n\n    this.challenges.forEach(challenge => {\n      const { category } = challenge;\n\n      if (!categories.includes(category)) {\n        categories.push(category);\n      }\n    });\n\n    try {\n      const f = CTFd.config.themeSettings.challenge_category_order;\n      if (f) {\n        const getSort = new Function(`return (${f})`);\n        categories.sort(getSort());\n      }\n    } catch (error) {\n      // Ignore errors with theme category sorting\n      console.log(\"Error running challenge_category_order function\");\n      console.log(error);\n    }\n\n    return categories;\n  },\n\n  getChallenges(category) {\n    let challenges = this.challenges;\n\n    if (category !== null) {\n      challenges = this.challenges.filter(challenge => challenge.category === category);\n    }\n\n    try {\n      const f = CTFd.config.themeSettings.challenge_order;\n      if (f) {\n        const getSort = new Function(`return (${f})`);\n        challenges.sort(getSort());\n      }\n    } catch (error) {\n      // Ignore errors with theme challenge sorting\n      console.log(\"Error running challenge_order function\");\n      console.log(error);\n    }\n\n    return challenges;\n  },\n\n  async loadChallenges() {\n    this.challenges = await CTFd.pages.challenges.getChallenges();\n  },\n\n  async loadChallenge(challengeId) {\n    await CTFd.pages.challenge.displayChallenge(challengeId, challenge => {\n      challenge.data.view = addTargetBlank(challenge.data.view);\n      Alpine.store(\"challenge\").data = challenge.data;\n\n      // nextTick is required here because we're working in a callback\n      Alpine.nextTick(() => {\n        let modal = Modal.getOrCreateInstance(\"[x-ref='challengeWindow']\");\n        // TODO: Get rid of this private attribute access\n        // See https://github.com/twbs/bootstrap/issues/31266\n        modal._element.addEventListener(\n          \"hidden.bs.modal\",\n          event => {\n            // Remove location hash\n            history.replaceState(null, null, \" \");\n          },\n          { once: true },\n        );\n        modal.show();\n        history.replaceState(null, null, `#${challenge.data.name}-${challengeId}`);\n      });\n    });\n  },\n}));\n\nAlpine.start();\n"],"names":["addTargetBlank","html","view","link","Alpine","event","hint","CTFd","unlock","highlight","styles","error","Tab","solve","dayjs","modal","Modal","body","url","t","Tooltip","chalHash","idx","id","categories","challenge","category","f","getSort","challenges","challengeId"],"mappings":"kFAQA,SAASA,EAAeC,EAAM,CAE5B,IAAIC,EADM,IAAI,YACC,gBAAgBD,EAAM,WAAW,EAEhD,OADYC,EAAK,iBAAiB,gBAAgB,EAC5C,QAAQC,GAAQ,CACpBA,EAAK,aAAa,SAAU,QAAQ,CACxC,CAAG,EACMD,EAAK,gBAAgB,SAC9B,CAEA,OAAO,OAASE,EAEhBA,EAAO,MAAM,YAAa,CACxB,KAAM,CACJ,KAAM,EACP,CACH,CAAC,EAEDA,EAAO,KAAK,OAAQ,KAAO,CACzB,GAAI,KACJ,KAAM,KAEN,MAAM,SAASC,EAAO,CACpB,GAAIA,EAAM,OAAO,KAAM,CAErB,IAAIC,GADW,MAAMC,EAAK,MAAM,UAAU,SAAS,KAAK,EAAE,GACtC,KACpB,GAAID,EAAK,QACP,KAAK,KAAON,EAAeM,EAAK,IAAI,UAEvB,MAAMC,EAAK,MAAM,UAAU,cAAc,KAAK,EAAE,EACjD,CACV,IAAIC,EAAS,MAAMD,EAAK,MAAM,UAAU,WAAW,KAAK,EAAE,EAE1D,GAAIC,EAAO,QAAS,CAElB,IAAIF,GADW,MAAMC,EAAK,MAAM,UAAU,SAAS,KAAK,EAAE,GACtC,KACpB,KAAK,KAAOP,EAAeM,EAAK,IAAI,CAChD,MACYD,EAAM,OAAO,KAAO,GACpBE,EAAK,WAAW,UAAU,mBAAmBC,CAAM,CAE/D,MACUH,EAAM,OAAO,KAAO,EAGzB,CACF,CACH,EAAE,EAEFD,EAAO,KAAK,YAAa,KAAO,CAC9B,GAAI,KACJ,QAAS,KACT,WAAY,GACZ,IAAK,KACL,OAAQ,CAAE,EACV,SAAU,KACV,UAAW,KACX,aAAc,EACd,SAAU,EAEV,MAAM,MAAO,CACXK,GACD,EAED,WAAY,CACV,IAAIC,EAAS,CACX,eAAgB,EACtB,EACI,GAAI,CAEF,OADWH,EAAK,OAAO,cAAc,sBACzB,CACV,IAAK,KACHG,EAAO,UAAU,EAAI,GACrB,MACF,IAAK,KACHA,EAAO,UAAU,EAAI,GACrB,MACF,IAAK,KACHA,EAAO,UAAU,EAAI,GACrB,MACF,QACE,KACH,CACF,OAAQC,EAAO,CAEd,QAAQ,IAAI,wCAAwC,EACpD,QAAQ,IAAIA,CAAK,CAClB,CACD,OAAOD,CACR,EAED,MAAM,MAAO,CACXD,GACD,EAED,MAAM,eAAgB,CACpB,IAAIG,EAAI,KAAK,GAAG,EAAE,KAAI,CACvB,EAED,MAAM,YAAa,CACjB,KAAK,OAAS,MAAML,EAAK,MAAM,UAAU,WAAW,KAAK,EAAE,EAC3D,KAAK,OAAO,QAAQM,IAClBA,EAAM,KAAOC,EAAMD,EAAM,IAAI,EAAE,OAAO,oBAAoB,EACnDA,EACR,EACD,IAAID,EAAI,KAAK,GAAG,EAAE,KAAI,CACvB,EAED,WAAY,CAEV,OADWR,EAAO,MAAM,WAAW,EAAE,KACzB,OACb,EAED,MAAM,eAAgB,CACpB,IAAIW,EAAQC,EAAM,oBAAoB,2BAA2B,EAIjED,EAAM,SAAS,iBACb,kBACAV,GAAS,CAEPD,EAAO,SAAS,IAAM,CACpB,KAAK,UAAU,iBAAkB,KAAK,UAAW,CAAA,CAC3D,CAAS,CACF,EACD,CAAE,KAAM,EAAM,CACpB,EACIW,EAAM,KAAI,CACX,EAED,MAAM,aAAc,CAClB,IAAIE,EAAO,CACT,KAAM,QACN,aAAc,KAAK,EACzB,EAMI,MAAMC,GADO,MAJI,MAAMX,EAAK,MAAM,iBAAkB,CAClD,OAAQ,OACR,KAAM,KAAK,UAAUU,CAAI,CAC/B,CAAK,GAC2B,QACX,KAAQ,IACzB,KAAK,UAAYC,CAClB,EAED,cAAe,CACb,UAAU,UAAU,UAAU,KAAK,SAAS,EAC5C,IAAIC,EAAIC,EAAQ,oBAAoB,KAAK,GAAG,EAC5CD,EAAE,OAAM,EACRA,EAAE,KAAI,EACN,WAAW,IAAM,CACfA,EAAE,KAAI,EACNA,EAAE,QAAO,CACV,EAAE,GAAI,CACR,EAED,MAAM,iBAAkB,CACtB,KAAK,SAAW,MAAMZ,EAAK,MAAM,UAAU,gBACzC,KAAK,GACL,KAAK,UACX,EAEI,MAAM,KAAK,0BACZ,EAED,MAAM,0BAA2B,CAC3B,KAAK,SAAS,KAAK,SAAW,YAChC,KAAK,WAAa,IAIhB,KAAK,aAAe,GAAK,KAAK,SAAS,KAAK,QAAU,mBACxD,KAAK,UAAY,GAInB,KAAK,UAAU,iBAAiB,CACjC,CACH,EAAE,EAEFH,EAAO,KAAK,iBAAkB,KAAO,CACnC,OAAQ,GACR,WAAY,CAAE,EACd,UAAW,KAEX,MAAM,MAAO,CAIX,GAHA,KAAK,WAAa,MAAMG,EAAK,MAAM,WAAW,gBAC9C,KAAK,OAAS,GAEV,OAAO,SAAS,KAAM,CACxB,IAAIc,EAAW,mBAAmB,OAAO,SAAS,KAAK,UAAU,CAAC,CAAC,EAC/DC,EAAMD,EAAS,YAAY,GAAG,EAClC,GAAIC,GAAO,EAAG,CAEZ,IAAIC,EADS,CAACF,EAAS,MAAM,EAAGC,CAAG,EAAGD,EAAS,MAAMC,EAAM,CAAC,CAAC,EAC7C,CAAC,EACjB,MAAM,KAAK,cAAcC,CAAE,CAC5B,CACF,CACF,EAED,eAAgB,CACd,MAAMC,EAAa,CAAA,EAEnB,KAAK,WAAW,QAAQC,GAAa,CACnC,KAAM,CAAE,SAAAC,CAAU,EAAGD,EAEhBD,EAAW,SAASE,CAAQ,GAC/BF,EAAW,KAAKE,CAAQ,CAEhC,CAAK,EAED,GAAI,CACF,MAAMC,EAAIpB,EAAK,OAAO,cAAc,yBACpC,GAAIoB,EAAG,CACL,MAAMC,EAAU,IAAI,SAAS,WAAWD,CAAC,GAAG,EAC5CH,EAAW,KAAKI,EAAO,CAAE,CAC1B,CACF,OAAQjB,EAAO,CAEd,QAAQ,IAAI,iDAAiD,EAC7D,QAAQ,IAAIA,CAAK,CAClB,CAED,OAAOa,CACR,EAED,cAAcE,EAAU,CACtB,IAAIG,EAAa,KAAK,WAElBH,IAAa,OACfG,EAAa,KAAK,WAAW,OAAOJ,GAAaA,EAAU,WAAaC,CAAQ,GAGlF,GAAI,CACF,MAAMC,EAAIpB,EAAK,OAAO,cAAc,gBACpC,GAAIoB,EAAG,CACL,MAAMC,EAAU,IAAI,SAAS,WAAWD,CAAC,GAAG,EAC5CE,EAAW,KAAKD,EAAO,CAAE,CAC1B,CACF,OAAQjB,EAAO,CAEd,QAAQ,IAAI,wCAAwC,EACpD,QAAQ,IAAIA,CAAK,CAClB,CAED,OAAOkB,CACR,EAED,MAAM,gBAAiB,CACrB,KAAK,WAAa,MAAMtB,EAAK,MAAM,WAAW,eAC/C,EAED,MAAM,cAAcuB,EAAa,CAC/B,MAAMvB,EAAK,MAAM,UAAU,iBAAiBuB,EAAaL,GAAa,CACpEA,EAAU,KAAK,KAAOzB,EAAeyB,EAAU,KAAK,IAAI,EACxDrB,EAAO,MAAM,WAAW,EAAE,KAAOqB,EAAU,KAG3CrB,EAAO,SAAS,IAAM,CACpB,IAAIW,EAAQC,EAAM,oBAAoB,2BAA2B,EAGjED,EAAM,SAAS,iBACb,kBACAV,GAAS,CAEP,QAAQ,aAAa,KAAM,KAAM,GAAG,CACrC,EACD,CAAE,KAAM,EAAM,CACxB,EACQU,EAAM,KAAI,EACV,QAAQ,aAAa,KAAM,KAAM,IAAIU,EAAU,KAAK,IAAI,IAAIK,CAAW,EAAE,CACjF,CAAO,CACP,CAAK,CACF,CACH,EAAE,EAEF1B,EAAO,MAAO"}